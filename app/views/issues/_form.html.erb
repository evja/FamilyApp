<%
  colors = @family.theme_colors
%>

<%= form_with model: [@family, @issue], local: true do |form| %>
  <div class="grid gap-6 max-w-3xl mx-auto">
    <div class="bg-white p-6 rounded-lg shadow border" style="border-color: <%= colors[:secondary] %>;">
      <div class="mb-6 bg-gray-50 rounded-lg p-4">
        <p class="text-sm font-medium mb-2" style="color: <%= colors[:primary] %>;">
          Issues are not problems to avoid â€” they are signals of growth.
        </p>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
          <div>
            <p class="font-medium text-green-700 mb-1">Try this:</p>
            <ul class="text-gray-600 space-y-1">
              <li>"Screen time boundaries feel inconsistent"</li>
              <li>"Mornings are rushed and stressful"</li>
            </ul>
          </div>
          <div>
            <p class="font-medium text-red-600 mb-1">Instead of:</p>
            <ul class="text-gray-600 space-y-1">
              <li>"The kids are always on screens"</li>
              <li>"Nobody helps in the morning"</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div>
        <%= form.label :description, "Describe The Issue", class: "block text-sm font-medium mb-1", style: "color: #{colors[:primary]}" %>
        <%= form.text_area :description, rows: 3,
            id: "issue_description",
            class: "w-full border rounded px-3 py-2 transition-all duration-300",
            style: "border-color: #{colors[:secondary]}; color: #{colors[:primary]};" %>
      </div>

      <!-- AI Assistant -->
      <% if defined?(@assist_remaining) %>
        <div x-data="issueAssist()" class="mt-3">
          <button
            type="button"
            @click="getAssist()"
            :disabled="loading"
            class="text-sm font-medium px-3 py-1.5 rounded border transition-all duration-300 disabled:opacity-50"
            style="border-color: <%= colors[:secondary] %>; color: <%= colors[:primary] %>;"
          >
            <span x-show="!loading">Help me say this better (<span x-text="remaining"></span> left today)</span>
            <span x-show="loading">Thinking...</span>
          </button>

          <template x-if="error">
            <p class="mt-2 text-sm text-red-600" x-text="error"></p>
          </template>

          <template x-if="suggested">
            <div class="mt-3 p-4 rounded-lg border bg-green-50 border-green-200">
              <p class="text-sm font-medium text-green-800 mb-1">Suggested reframe:</p>
              <p class="text-sm text-gray-800 mb-2" x-text="suggested"></p>
              <template x-if="tip">
                <p class="text-xs text-gray-500 italic mb-3" x-text="'Tip: ' + tip"></p>
              </template>
              <div class="flex gap-2">
                <button type="button" @click="useThis()" class="text-xs font-medium px-3 py-1 rounded text-white" style="background-color: <%= colors[:primary] %>;">
                  Use This
                </button>
                <button type="button" @click="keepMine()" class="text-xs font-medium px-3 py-1 rounded border" style="border-color: <%= colors[:secondary] %>; color: <%= colors[:primary] %>;">
                  Keep Mine
                </button>
              </div>
            </div>
          </template>
        </div>

        <script>
          function issueAssist() {
            return {
              loading: false,
              suggested: null,
              tip: null,
              error: null,
              remaining: <%= @assist_remaining %>,
              async getAssist() {
                var textarea = document.getElementById('issue_description');
                var description = textarea.value.trim();
                if (!description) {
                  this.error = 'Oops.. white some description first so i know best how to help.';
                  return;
                }
                this.loading = true;
                this.error = null;
                this.suggested = null;
                this.tip = null;
                try {
                  var response = await fetch('<%= family_issue_assists_path(@family) %>', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({ description: description })
                  });
                  var data = await response.json();
                  if (!response.ok) {
                    this.error = data.error || 'Something went wrong.';
                  } else {
                    this.suggested = data.suggested;
                    this.tip = data.tip;
                    this.remaining = data.remaining;
                  }
                } catch (e) {
                  this.error = 'Could not reach the server. Please try again.';
                } finally {
                  this.loading = false;
                }
              },
              useThis() {
                document.getElementById('issue_description').value = this.suggested;
                this.suggested = null;
                this.tip = null;
              },
              keepMine() {
                this.suggested = null;
                this.tip = null;
              }
            };
          }
        </script>
      <% end %>

      <!-- Urgency -->
      <div class="mt-6">
        <%= form.label :urgency, "Urgency", class: "block text-sm font-medium mb-1", style: "color: #{colors[:primary]}" %>
        <%= form.select :urgency, ["Low", "Medium", "High"], {},
            class: "w-full border rounded px-3 py-2 transition-all duration-300",
            style: "border-color: #{colors[:secondary]}; color: #{colors[:primary]};" %>
      </div>

      <!-- List Type Selector -->
      <div class="mt-6">
        <label class="block text-sm font-medium mb-2" style="color: <%= colors[:primary] %>;">Visibility</label>
        <div class="grid grid-cols-3 gap-2" x-data="{ selected: '<%= @issue.list_type || 'family' %>' }">
          <% [
            ['family', 'Family', 'Everyone sees'],
            ['parent', 'Parents', 'Parents only'],
            ['individual', 'Individual', 'Tagged members']
          ].each do |value, label, hint| %>
            <label class="cursor-pointer">
              <input type="radio" name="issue[list_type]" value="<%= value %>"
                     class="sr-only" x-model="selected"
                     <%= 'checked' if (@issue.list_type || 'family') == value %>>
              <div class="text-center py-2 px-2 rounded-lg border-2 transition-all text-sm"
                   :class="selected === '<%= value %>' ? 'border-current shadow-md' : 'border-gray-200'"
                   :style="selected === '<%= value %>' ? 'background-color: <%= colors[:primary] %>; color: white; border-color: <%= colors[:primary] %>;' : ''">
                <div class="font-medium"><%= label %></div>
                <div class="text-xs opacity-70"><%= hint %></div>
              </div>
            </label>
          <% end %>
        </div>
      </div>

      <!-- Member Tagging -->
      <div class="mt-6">
        <label class="block text-sm font-medium mb-2" style="color: <%= colors[:primary] %>;">Tag Members (optional)</label>
        <p class="text-xs text-gray-500 mb-3">Who is this issue about?</p>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-48 overflow-y-auto p-1">
          <% @members.each do |member| %>
            <label class="flex items-center gap-2 p-2 rounded border border-gray-200 hover:bg-gray-50 cursor-pointer">
              <%= check_box_tag "issue[member_ids][]", member.id,
                  @issue.member_ids.include?(member.id),
                  id: "member_#{member.id}",
                  class: "rounded border-gray-300 text-current" %>
              <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white flex-shrink-0"
                    style="background-color: <%= member.display_color %>;">
                <%= member.avatar_display %>
              </span>
              <span class="text-sm text-gray-700 truncate"><%= member.display_name %></span>
            </label>
          <% end %>
        </div>
      </div>

      <% if @return_to.present? %>
        <%= hidden_field_tag :return_to, @return_to %>
      <% end %>
      <% if @modal_mode %>
        <%= hidden_field_tag :modal, 'true' %>
      <% end %>

      <!-- Buttons -->
      <div class="flex flex-wrap items-center gap-4 mt-6">
        <%= form.submit "Save Issue",
            class: "px-4 py-2 rounded transition-all duration-300",
            style: "background-color: #{colors[:primary]}; color: white; hover:background-color: #{colors[:secondary]};" %>
        <%= link_to "Cancel", (@return_to.presence || family_issues_path(@family)),
            class: "text-sm hover:underline",
            style: "color: #{colors[:secondary]};" %>
      </div>
    </div>
  </div>
<% end %>
