<%
  colors = family.theme_colors
%>

<%= form_with model: [family, rhythm], local: true, data: { controller: "nested-form" } do |f| %>
  <% if rhythm.errors.any? %>
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
      <ul class="list-disc list-inside">
        <% rhythm.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="space-y-6">
    <!-- Basic Info -->
    <div class="grid gap-4 sm:grid-cols-2">
      <div>
        <%= f.label :name, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :name, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2", style: "focus:ring-color: #{colors[:primary]};" %>
      </div>

      <div>
        <%= f.label :rhythm_category, "Category", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :rhythm_category, Rhythm::CATEGORY_LABELS.map { |k, v| [v, k] }, {}, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2" %>
      </div>
    </div>

    <div>
      <%= f.label :description, class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= f.text_area :description, rows: 2, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2" %>
    </div>

    <div class="grid gap-4 sm:grid-cols-2">
      <div>
        <%= f.label :frequency_type, "Frequency", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :frequency_type, Rhythm::FREQUENCY_LABELS.map { |k, v| [v, k] }, {}, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2" %>
      </div>

      <div class="flex items-center gap-2 pt-6">
        <%= f.check_box :is_active, class: "h-4 w-4 rounded border-gray-300" %>
        <%= f.label :is_active, "Active (will show in rhythm list)", class: "text-sm text-gray-700" %>
      </div>
    </div>

    <!-- Agenda Items -->
    <% if rhythm.persisted? %>
      <div class="border-t pt-6">
        <h4 class="text-lg font-medium theme-text mb-4">Agenda Items</h4>

        <div data-nested-form-target="container" class="space-y-4">
          <%= f.fields_for :agenda_items do |item_form| %>
            <div class="p-4 bg-gray-50 rounded-lg border" data-nested-form-target="item">
              <div class="grid gap-3 sm:grid-cols-2">
                <div class="sm:col-span-2">
                  <%= item_form.label :title, class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= item_form.text_field :title, class: "w-full px-3 py-2 border border-gray-300 rounded-md text-sm" %>
                </div>

                <div>
                  <%= item_form.label :duration_minutes, "Duration (minutes)", class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= item_form.number_field :duration_minutes, min: 1, class: "w-full px-3 py-2 border border-gray-300 rounded-md text-sm" %>
                </div>

                <div>
                  <%= item_form.label :link_type, "Quick Link", class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= item_form.select :link_type, AgendaItem::LINK_LABELS.map { |k, v| [v, k] }, {}, class: "w-full px-3 py-2 border border-gray-300 rounded-md text-sm" %>
                </div>

                <div class="sm:col-span-2">
                  <%= item_form.label :instructions, class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= item_form.text_area :instructions, rows: 2, class: "w-full px-3 py-2 border border-gray-300 rounded-md text-sm" %>
                </div>

                <%= item_form.hidden_field :position %>
                <%= item_form.hidden_field :id %>
              </div>

              <div class="mt-3 flex justify-end">
                <%= item_form.check_box :_destroy, class: "hidden", id: "destroy_#{item_form.object.id}" %>
                <button type="button" onclick="this.closest('[data-nested-form-target=\"item\"]').querySelector('input[name*=\"_destroy\"]').value = '1'; this.closest('[data-nested-form-target=\"item\"]').style.display = 'none';" class="text-sm text-red-600 hover:text-red-800">
                  Remove
                </button>
              </div>
            </div>
          <% end %>
        </div>

        <p class="text-sm text-gray-500 mt-4">
          To add new agenda items, save this rhythm first, then use the meeting runner to see them in action.
        </p>
      </div>
    <% else %>
      <p class="text-sm text-gray-500 border-t pt-4">
        After creating this rhythm, you can add agenda items by editing it.
      </p>
    <% end %>

    <div class="flex gap-3 pt-4">
      <%= f.submit rhythm.persisted? ? "Update Rhythm" : "Create Rhythm", class: "theme-button-filled cursor-pointer" %>
      <% if rhythm.persisted? %>
        <%= link_to "Cancel", family_rhythm_path(family, rhythm), class: "theme-button-outline" %>
      <% else %>
        <%= link_to "Cancel", family_rhythms_path(family), class: "theme-button-outline" %>
      <% end %>
    </div>
  </div>
<% end %>
