<%
  colors = family.theme_colors
%>

<%= form_with model: [family, rhythm], local: true, data: { controller: "nested-form" } do |f| %>
  <% if rhythm.errors.any? %>
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
      <ul class="list-disc list-inside">
        <% rhythm.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="space-y-6">
    <!-- Basic Info -->
    <div class="grid gap-4 sm:grid-cols-2">
      <div>
        <%= f.label :name, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :name, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2", style: "focus:ring-color: #{colors[:primary]};" %>
      </div>

      <div>
        <%= f.label :rhythm_category, "Category", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :rhythm_category, Rhythm::CATEGORY_LABELS.map { |k, v| [v, k] }, {}, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2" %>
      </div>
    </div>

    <div>
      <%= f.label :description, class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= f.text_area :description, rows: 2, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2" %>
    </div>

    <div class="grid gap-4 sm:grid-cols-2">
      <div>
        <%= f.label :frequency_type, "Frequency", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :frequency_type, Rhythm::FREQUENCY_LABELS.map { |k, v| [v, k] }, {}, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2" %>
      </div>

      <div class="flex items-center gap-2 pt-6">
        <%= f.check_box :is_active, class: "h-4 w-4 rounded border-gray-300" %>
        <%= f.label :is_active, "Active (will show in rhythm list)", class: "text-sm text-gray-700" %>
      </div>
    </div>

    <!-- Agenda Items -->
    <% if rhythm.persisted? %>
      <div class="border-t pt-6">
        <div class="flex items-center justify-between mb-4">
          <h4 class="text-lg font-medium theme-text">Agenda Items</h4>
          <%= link_to new_family_rhythm_agenda_item_path(family, rhythm), class: "theme-button-filled text-sm" do %>
            + Add Item
          <% end %>
        </div>

        <% if rhythm.agenda_items.any? %>
          <div class="space-y-3 mb-4">
            <% rhythm.agenda_items.ordered.each do |item| %>
              <div class="p-4 bg-gray-50 rounded-lg border flex items-start justify-between gap-4">
                <div class="flex-grow">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-xs text-gray-400 font-mono"><%= item.position %>.</span>
                    <span class="font-medium text-gray-900"><%= item.title %></span>
                    <% if item.duration_minutes.present? %>
                      <span class="text-xs text-gray-500">(<%= item.duration_display %>)</span>
                    <% end %>
                    <% if item.has_link? %>
                      <span class="text-xs px-2 py-0.5 rounded-full" style="background-color: <%= colors[:secondary] %>; color: <%= colors[:primary] %>;">
                        <%= item.link_label %>
                      </span>
                    <% end %>
                  </div>
                  <% if item.instructions.present? %>
                    <p class="text-sm text-gray-600 mt-1"><%= truncate(item.instructions, length: 100) %></p>
                  <% end %>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <%= link_to "Edit", edit_family_rhythm_agenda_item_path(family, rhythm, item), class: "text-sm text-gray-600 hover:text-gray-800" %>
                  <%= link_to "Remove", family_rhythm_agenda_item_path(family, rhythm, item),
                      data: { turbo_method: :delete, turbo_confirm: "Remove this agenda item?" },
                      class: "text-sm text-red-600 hover:text-red-800" %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-8 bg-gray-50 rounded-lg border border-dashed border-gray-300">
            <p class="text-gray-500 mb-3">No agenda items yet</p>
            <%= link_to "Add your first agenda item", new_family_rhythm_agenda_item_path(family, rhythm), class: "text-sm font-medium", style: "color: #{colors[:primary]};" %>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-sm text-gray-500 border-t pt-4">
        After creating this rhythm, you can add agenda items by editing it.
      </p>
    <% end %>

    <div class="flex gap-3 pt-4">
      <%= f.submit rhythm.persisted? ? "Update Rhythm" : "Create Rhythm", class: "theme-button-filled cursor-pointer" %>
      <% if rhythm.persisted? %>
        <%= link_to "Cancel", family_rhythm_path(family, rhythm), class: "theme-button-outline" %>
      <% else %>
        <%= link_to "Cancel", family_rhythms_path(family), class: "theme-button-outline" %>
      <% end %>
    </div>
  </div>
<% end %>
