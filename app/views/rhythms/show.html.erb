<%
  colors = @family.theme_colors
  current_meeting = @rhythm.current_meeting
%>

<div class="max-w-4xl mx-auto">
  <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
    <div>
      <h2 class="text-2xl font-bold theme-text"><%= @rhythm.name %></h2>
      <p class="text-gray-600 mt-1"><%= @rhythm.description %></p>
    </div>
    <span class="text-sm font-medium px-3 py-1 rounded-full <%= @rhythm.status_color %>">
      <%= @rhythm.status_label %>
    </span>
  </div>

  <!-- Rhythm Details -->
  <div class="bg-white p-6 rounded-lg shadow border theme-border mb-6">
    <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-gray-500">Frequency</span>
        <p class="font-medium theme-text"><%= @rhythm.frequency_label %></p>
      </div>
      <div>
        <span class="text-gray-500">Duration</span>
        <p class="font-medium theme-text"><%= @rhythm.duration_display || "Not set" %></p>
      </div>
      <div>
        <span class="text-gray-500">Agenda Items</span>
        <p class="font-medium theme-text"><%= @rhythm.agenda_items.count %> items</p>
      </div>
      <div>
        <span class="text-gray-500">Next Due</span>
        <p class="font-medium theme-text">
          <% if @rhythm.next_due_at && @rhythm.is_active %>
            <%= @rhythm.next_due_at.strftime('%B %d, %Y') %>
            <% if @rhythm.overdue? %>
              <span class="text-red-600 text-xs">(overdue)</span>
            <% end %>
          <% else %>
            Not scheduled
          <% end %>
        </p>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="flex flex-wrap gap-3 mb-8">
    <% if current_meeting %>
      <%= link_to "Continue Meeting", run_family_rhythm_path(@family, @rhythm),
          class: "theme-button-filled" %>
      <span class="text-sm text-gray-500 self-center">
        Meeting in progress - <%= current_meeting.progress_percentage %>% complete
      </span>
    <% elsif @rhythm.is_active %>
      <%= button_to "Start Meeting", start_family_rhythm_path(@family, @rhythm),
          method: :post,
          class: "theme-button-filled" %>
      <%= button_to "Skip This Time", skip_family_rhythm_path(@family, @rhythm),
          method: :post,
          class: "theme-button-outline",
          form: { data: { turbo_confirm: "Skip this occurrence?" } } %>
    <% end %>
    <%= link_to "Edit Rhythm", edit_family_rhythm_path(@family, @rhythm),
        class: "theme-button-outline" %>
  </div>

  <!-- Agenda Preview -->
  <div class="bg-white p-6 rounded-lg shadow border theme-border mb-6">
    <h3 class="text-lg font-semibold theme-text mb-4">Agenda</h3>

    <% if @rhythm.agenda_items.any? %>
      <ol class="space-y-3">
        <% @rhythm.agenda_items.each_with_index do |item, index| %>
          <li class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
            <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-sm font-medium text-white" style="background-color: <%= colors[:primary] %>;">
              <%= index + 1 %>
            </span>
            <div class="flex-grow">
              <div class="flex items-center gap-2 flex-wrap">
                <span class="font-medium theme-text"><%= item.title %></span>
                <% if item.duration_display %>
                  <span class="text-xs text-gray-500">(<%= item.duration_display %>)</span>
                <% end %>
                <% if item.link_available? %>
                  <span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">
                    <%= item.link_label %>
                  </span>
                <% end %>
              </div>
              <% if item.instructions.present? %>
                <p class="text-sm text-gray-600 mt-1"><%= item.instructions %></p>
              <% end %>
            </div>
          </li>
        <% end %>
      </ol>
    <% else %>
      <p class="text-gray-500">No agenda items yet. <%= link_to "Add some", edit_family_rhythm_path(@family, @rhythm), class: "theme-link" %>.</p>
    <% end %>
  </div>

  <!-- Recent Completions -->
  <% if @recent_completions.any? %>
    <div class="bg-white p-6 rounded-lg shadow border theme-border mb-6">
      <h3 class="text-lg font-semibold theme-text mb-4">Recent Meetings</h3>
      <div class="space-y-3">
        <% @recent_completions.each do |completion| %>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div>
              <span class="text-sm font-medium theme-text">
                <%= completion.completed_at.strftime('%B %d, %Y') %>
              </span>
              <% if completion.duration_display %>
                <span class="text-xs text-gray-500 ml-2">(<%= completion.duration_display %>)</span>
              <% end %>
            </div>
            <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">Completed</span>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Delete -->
  <div class="border-t pt-6 mt-6">
    <%= button_to "Delete Rhythm", family_rhythm_path(@family, @rhythm),
        method: :delete,
        class: "text-sm text-red-600 hover:text-red-800",
        form: { data: { turbo_confirm: "Are you sure you want to delete this rhythm? This cannot be undone." } } %>
  </div>

  <%= link_to "&larr; Back to Rhythms".html_safe, family_rhythms_path(@family),
      class: "theme-button-outline text-sm mt-6 inline-block" %>
</div>
