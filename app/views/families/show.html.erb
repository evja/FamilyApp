<%
  colors = @family.theme_colors
%>

<div class="max-w-6xl mx-auto mt-6 md:mt-12 px-4 md:px-6">
  <div class="mb-8">
    <h2 class="text-3xl font-bold" style="color: <%= colors[:primary] %>">
      <%= @family.name %> Dashboard
    </h2>
  </div>
  
  <%# Progressive Unlock - Next Step Banner %>
  <% unless show_admin_features? %>
    <% if next_module = next_unlockable_module %>
      <!-- Next Step Banner -->
      <div class="mb-8 bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 rounded-lg shadow-sm overflow-hidden" style="border-left-color: <%= colors[:primary] %>;">
        <div class="p-6">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center shadow-lg" style="background-color: <%= colors[:primary] %>;">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900 mb-1">
                Next Step: <%= next_module.to_s.titleize %>
              </h3>
              <p class="text-gray-700 mb-2"><%= module_unlock_message(next_module) %></p>
              <p class="text-sm text-gray-600 mb-3"><%= module_unlock_condition(next_module) %></p>

              <% if progress = module_unlock_progress(next_module) %>
                <% if progress[:type] == :blocked %>
                  <div class="text-sm text-amber-700 bg-amber-50 rounded px-3 py-2 inline-block">
                    <%= progress[:prerequisite] %>
                  </div>
                <% elsif progress[:type] == :boolean %>
                  <% if progress[:complete] %>
                    <div class="text-sm font-medium text-green-700 bg-green-50 rounded px-3 py-2 inline-flex items-center gap-2">
                      Ready to unlock!
                    </div>
                  <% end %>
                <% elsif progress[:type] == :numeric %>
                  <div class="mt-2">
                    <div class="flex justify-between text-sm mb-1">
                      <span class="text-gray-600">Progress</span>
                      <span class="font-medium"><%= progress[:current] %>/<%= progress[:required] %> <%= progress[:label] %></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                      <div class="h-2.5 rounded-full transition-all duration-500" style="width: <%= [[progress[:current].to_f / progress[:required] * 100, 100].min, 0].max %>%; background-color: <%= colors[:primary] %>;"></div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <!-- All unlocked celebration -->
      <div class="mb-8 bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 rounded-lg shadow-sm p-6">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-900">All Modules Unlocked!</h3>
            <p class="text-gray-700">You have full access to FamilyHub.</p>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <%# First Rhythm Banner - For parents without rhythms %>
  <% if @show_first_rhythm_prompt %>
    <%= render 'families/first_rhythm_banner' %>
  <% end %>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-8">
    <%# Order matches progression: Stabilize → Orient → Operate %>
    <% dashboard_items = [
      { label: "Issues", icon: "alert-circle", path: family_issues_path(@family), badge_count: @issues_needing_attention },
      { label: "Relationships", icon: "heart", path: family_relationships_path(@family), badge_count: @relationships_needing_attention_count },
      { label: "Rhythms", icon: "repeat", path: family_rhythms_path(@family), badge_count: @overdue_rhythms_count },
      { label: "Vision", icon: "eye", path: family_vision_path(@family), badge_count: @vision_incomplete_count },
      { label: "Responsibilities", icon: "check-square", path: family_maturity_levels_path(@family), badge_count: nil },
      { label: "Rituals", icon: "mountain", path: family_rituals_path(@family), badge_count: @rituals_count > 0 ? @rituals_count : nil }
    ] %>

    <% dashboard_items.each do |item| %>
      <% module_key = item[:label].downcase.to_sym %>
      <% is_unlocked = module_unlocked?(module_key) %>
      <% is_hidden_by_admin = session[:hidden_modules]&.include?(item[:label]) %>
      <% next if is_hidden_by_admin && !show_admin_features? %>

      <%# Two-level access: progression unlock AND subscription %>
      <%# 1. Progression lock: must complete previous steps to unlock %>
      <%# 2. Subscription lock: only Issues is free, rest need subscription %>
      <% has_subscription = current_user.has_full_access? %>
      <% is_free_module = item[:label] == "Issues" %>
      <% is_available = is_unlocked && (has_subscription || is_free_module) %>
      <% progression_locked = !is_unlocked %>
      <% subscription_locked = is_unlocked && !has_subscription && !is_free_module %>

      <%= link_to is_available ? item[:path] : "#",
          class: "block bg-white shadow rounded-lg p-6 transition-all duration-300 ease-in-out group relative overflow-hidden #{is_available ? 'hover:shadow-lg hover:scale-[1.02]' : 'cursor-not-allowed opacity-75'}",
          style: "border: 2px solid #{!is_available ? colors[:secondary] + '40' : 'transparent'};" do %>

        <%# Notification Badge - only for available modules %>
        <% if is_available && item[:badge_count].to_i > 0 %>
          <%= render 'shared/notification_badge', count: item[:badge_count] %>
        <% end %>

        <%# Lock icon for unavailable modules %>
        <% unless is_available %>
          <div class="absolute top-3 right-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                 style="color: <%= progression_locked ? '#9CA3AF' : colors[:secondary] %>;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>
        <% end %>

        <div class="flex flex-col items-start gap-3 relative z-10">
          <div class="p-2 rounded-full bg-white shadow-sm transition-all duration-300 <%= is_available ? 'group-hover:shadow-md' : '' %>"
               style="color: <%= is_available ? colors[:primary] : '#9CA3AF' %>; background-color: <%= is_available ? colors[:background] : '#F3F4F6' %>;">
            <svg data-lucide="<%= item[:icon] %>" class="w-6 h-6 <%= is_available ? 'transition-transform group-hover:scale-110' : '' %>"></svg>
          </div>

          <h3 class="text-xl font-semibold <%= is_available ? 'transition-colors duration-300 group-hover:translate-x-1' : '' %>"
              style="color: <%= is_available ? colors[:primary] : '#6B7280' %>"><%= item[:label].upcase %></h3>

          <p class="text-sm <%= is_available ? 'text-gray-600 transition-all duration-300 group-hover:translate-x-1' : 'text-gray-400' %>">
            <% if progression_locked %>
              <%# Show unlock condition for progression-locked modules %>
              <%= module_unlock_condition(module_key) %>
            <% elsif subscription_locked %>
              <%# Show module status but indicate subscription needed %>
              <% case item[:label] %>
              <% when "Relationships" %>
                Track family connections
              <% when "Rhythms" %>
                Schedule regular meetings
              <% when "Vision" %>
                Define your family direction
              <% when "Responsibilities" %>
                Age-appropriate expectations
              <% when "Rituals" %>
                Meaningful traditions
              <% end %>
            <% else %>
              <%# Normal status for available modules %>
              <% case item[:label] %>
              <% when "Issues" %>
                <% if @issues_needing_attention.to_i > 0 %>
                  <%= pluralize(@issues_needing_attention, 'issue') %> needs attention
                <% elsif @has_any_issues %>
                  All issues resolved
                <% else %>
                  No issues logged yet
                <% end %>
              <% when "Vision" %>
                <% if @vision_incomplete_count.to_i > 0 %>
                  <%= pluralize(@vision_incomplete_count, 'section') %> to complete
                <% else %>
                  Vision complete
                <% end %>
              <% when "Rhythms" %>
                <% if @overdue_rhythms_count.to_i > 0 %>
                  <%= pluralize(@overdue_rhythms_count, 'rhythm') %> overdue
                <% elsif @has_any_rhythms %>
                  All rhythms on track
                <% else %>
                  No rhythms set up yet
                <% end %>
              <% when "Relationships" %>
                <% if @relationships_needing_attention_count.to_i > 0 %>
                  <%= pluralize(@relationships_needing_attention_count, 'relationship') %> to assess
                <% else %>
                  All relationships healthy
                <% end %>
              <% when "Responsibilities" %>
                <% if @has_maturity_chart %>
                  View maturity chart
                <% else %>
                  Set up maturity chart
                <% end %>
              <% when "Rituals" %>
                <% if @rituals_count.to_i > 0 %>
                  <%= pluralize(@rituals_count, 'active ritual') %>
                <% elsif @has_any_rituals %>
                  No active rituals
                <% else %>
                  No rituals set up yet
                <% end %>
              <% end %>
            <% end %>
          </p>

          <%# Lock status indicator %>
          <% if progression_locked %>
            <span class="mt-1 text-xs font-medium px-2 py-1 bg-gray-100 text-gray-500 rounded inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              Complete steps to unlock
            </span>
          <% elsif subscription_locked %>
            <span class="mt-1 text-xs font-medium px-2 py-1 rounded inline-flex items-center gap-1" style="background-color: <%= colors[:primary] %>15; color: <%= colors[:primary] %>;">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              Subscribe to unlock
            </span>
          <% elsif show_admin_features? && is_hidden_by_admin %>
            <span class="mt-1 text-xs font-medium px-2 py-1 bg-yellow-100 text-yellow-800 rounded">
              Admin Preview - Hidden
            </span>
          <% end %>
        </div>

        <% if is_available %>
          <div class="absolute inset-0 bg-current opacity-0 transition-opacity duration-300 group-hover:opacity-5"
               style="background-color: <%= colors[:primary] %>;"></div>
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const icons = document.querySelectorAll("[data-lucide]");
    if (window.lucide) {
      icons.forEach(icon => window.lucide.createIcons({
        icons: {
          [icon.dataset.lucide]: {
            element: icon
          }
        }
      }));
    }
  });
</script>